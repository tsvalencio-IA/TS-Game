<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>thIAguinho Wii - Ultimate Mobile</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Russo+One&family=Teko:wght@300;700&display=swap');

        body {
            background-color: #050505;
            margin: 0;
            overflow: hidden;
            font-family: 'Russo One', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* V√≠deo Oculto (Processamento) */
        #video-source {
            display: none;
        }
        
        /* Webcam Fundo (Visual) */
        #webcam {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            filter: brightness(0.6) contrast(1.2);
            z-index: 0;
        }

        /* Canvas do Jogo */
        #game-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        /* UI Layers */
        .ui-layer {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 20; pointer-events: none;
        }
        .interactive { pointer-events: auto !important; }
        .hidden { display: none !important; }

        /* Estilos Visuais */
        .title-glitch {
            font-family: 'Black Ops One', cursive;
            text-shadow: 2px 2px 0px #00ffff, -2px -2px 0px #ff00ff;
            animation: pulseTitle 3s infinite;
        }
        @keyframes pulseTitle { 0% {transform:scale(1);} 50% {transform:scale(1.02);} 100% {transform:scale(1);} }

        .btn-arcade {
            background: linear-gradient(180deg, #222, #111);
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 0 #000;
            transition: transform 0.1s;
        }
        .btn-arcade:active { transform: translateY(4px); box-shadow: 0 0 0 #000; }
        
        .mode-drive { border-color: #ff0055; }
        .mode-run { border-color: #00ff55; }
        .mode-fight { border-color: #aa00ff; }

        /* Feedback de Erro/Loading */
        .status-text { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <video id="video-source" playsinline></video>
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="game-canvas"></canvas>

    <div id="screen-start" class="ui-layer bg-black interactive z-50">
        <h1 class="text-6xl text-white font-black italic mb-2 title-glitch text-center">
            thIAguinho<br><span class="text-cyan-400">Wii</span>
        </h1>
        <p class="text-gray-400 mb-8 text-sm font-mono">AR MOTION ENGINE</p>
        
        <button onclick="GameSystem.init()" class="bg-cyan-600 hover:bg-cyan-500 text-white text-xl py-4 px-12 rounded-full font-bold shadow-[0_0_20px_rgba(6,182,212,0.5)] animate-bounce">
            TOCAR PARA INICIAR
        </button>
        <p class="text-gray-600 text-xs mt-8 max-w-xs text-center">Requer permiss√£o de c√¢mera e boa ilumina√ß√£o.</p>
    </div>

    <div id="screen-loading" class="ui-layer bg-black/90 hidden z-50">
        <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 id="loading-text" class="text-2xl text-white font-bold status-text text-center px-4">INICIALIZANDO C√ÇMERA...</h2>
        <div class="w-64 h-2 bg-gray-800 rounded mt-4 overflow-hidden">
            <div id="loading-bar" class="h-full bg-cyan-500 w-0 transition-all duration-300"></div>
        </div>
        <p id="error-msg" class="text-red-500 mt-4 text-sm font-mono hidden max-w-md text-center bg-black/50 p-2 rounded border border-red-900"></p>
        <button id="btn-retry" onclick="location.reload()" class="hidden mt-6 border border-white text-white px-4 py-2 rounded uppercase text-sm interactive">Tentar Novamente</button>
    </div>

    <div id="screen-menu" class="ui-layer bg-black/80 hidden interactive z-40 overflow-y-auto py-8">
        <h2 class="text-4xl text-white font-black mb-8 italic tracking-tighter">ESCOLHA O JOGO</h2>
        
        <div class="grid grid-cols-1 gap-4 w-full max-w-md px-6">
            <button onclick="GameSystem.start('drive')" class="btn-arcade mode-drive p-5 rounded-xl flex items-center gap-4 group">
                <span class="text-4xl">üèéÔ∏è</span>
                <div class="text-left">
                    <div class="text-xl text-white font-bold">NEON RACER</div>
                    <div class="text-xs text-white/50">Use as m√£os como volante</div>
                </div>
            </button>

            <button onclick="GameSystem.start('run')" class="btn-arcade mode-run p-5 rounded-xl flex items-center gap-4 group">
                <span class="text-4xl">üèÉ</span>
                <div class="text-left">
                    <div class="text-xl text-white font-bold">STREET RUN</div>
                    <div class="text-xs text-white/50">Corra e desvie com o corpo</div>
                </div>
            </button>

            <button onclick="GameSystem.start('fight')" class="btn-arcade mode-fight p-5 rounded-xl flex items-center gap-4 group">
                <span class="text-4xl">ü•ä</span>
                <div class="text-left">
                    <div class="text-xl text-white font-bold">GYM FIGHTER</div>
                    <div class="text-xs text-white/50">Soque os alvos no ritmo</div>
                </div>
            </button>
        </div>
        
        <div class="mt-8 opacity-50 text-xs text-cyan-400 font-mono">Desenvolvido com ü§ñ por thIAguinho Solu√ß√µes</div>
    </div>

    <div id="screen-hud" class="ui-layer hidden pointer-events-none justify-between p-4">
        <div class="w-full flex justify-between items-start">
            <div class="bg-black/60 backdrop-blur border-l-4 border-cyan-500 px-4 py-2">
                <div class="text-[10px] text-cyan-300 uppercase">SCORE</div>
                <div id="hud-score" class="text-3xl text-white font-mono">0000</div>
            </div>
            <button onclick="GameSystem.stop()" class="bg-red-600 text-white w-10 h-10 rounded-full font-bold border-2 border-white/20 interactive flex items-center justify-center">X</button>
        </div>
        
        <div id="hud-message" class="absolute top-1/3 w-full text-center"></div>

        <div class="interactive absolute bottom-4 right-4 bg-black/80 p-2 rounded border border-white/20">
            <label class="text-[10px] text-gray-400 block text-center">SENSIBILIDADE</label>
            <input type="range" min="0.5" max="3" step="0.5" value="1.5" class="w-24 accent-cyan-500" oninput="GameSystem.setSens(this.value)">
        </div>
    </div>

    <div id="screen-gameover" class="ui-layer bg-red-900/95 hidden interactive z-50">
        <h1 class="text-5xl text-white font-black italic mb-4">GAME OVER</h1>
        <div class="text-6xl text-yellow-400 font-mono font-bold mb-8" id="final-score">0</div>
        <button onclick="GameSystem.showMenu()" class="btn-arcade px-8 py-3 rounded-full text-white font-bold text-lg">MENU PRINCIPAL</button>
    </div>

    <script>
        /**
         * ==========================================
         * CORE ENGINE (Mobile Robustness)
         * ==========================================
         */
        const GameSystem = {
            state: {
                active: false,
                gameType: null,
                score: 0,
                sensitivity: 1.5,
                loopId: null
            },
            elements: {
                videoInput: document.getElementById('video-source'),
                videoDisplay: document.getElementById('webcam'),
                canvas: document.getElementById('game-canvas'),
                ctx: document.getElementById('game-canvas').getContext('2d'),
                loadingText: document.getElementById('loading-text'),
                loadingBar: document.getElementById('loading-bar'),
                errorMsg: document.getElementById('error-msg'),
                btnRetry: document.getElementById('btn-retry')
            },
            models: {
                detector: null
            },

            // 1. Inicializa√ß√£o Controlada
            init: async () => {
                const { elements } = GameSystem;
                
                // UI Switch
                document.getElementById('screen-start').classList.add('hidden');
                document.getElementById('screen-loading').classList.remove('hidden');

                try {
                    // Passo 1: C√¢mera (Permiss√£o Cr√≠tica)
                    elements.loadingText.innerText = "SOLICITANDO C√ÇMERA...";
                    elements.loadingBar.style.width = "30%";
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        },
                        audio: false
                    });

                    elements.videoInput.srcObject = stream;
                    elements.videoDisplay.srcObject = stream;
                    
                    // Esperar v√≠deo estar pronto de verdade
                    await new Promise((resolve) => {
                        elements.videoInput.onloadedmetadata = () => {
                            elements.videoInput.play();
                            elements.videoDisplay.play();
                            resolve();
                        };
                    });

                    // Passo 2: Carregar IA (Pesado)
                    elements.loadingText.innerText = "BAIXANDO REDE NEURAL (IA)...";
                    elements.loadingBar.style.width = "60%";
                    
                    await tf.setBackend('webgl');
                    
                    const detectorConfig = { 
                        modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING,
                        enableSmoothing: true
                    };
                    GameSystem.models.detector = await poseDetection.createDetector(
                        poseDetection.SupportedModels.MoveNet, 
                        detectorConfig
                    );

                    elements.loadingBar.style.width = "100%";
                    
                    // Sucesso!
                    setTimeout(() => {
                        document.getElementById('screen-loading').classList.add('hidden');
                        document.getElementById('screen-menu').classList.remove('hidden');
                        document.getElementById('screen-menu').classList.add('flex');
                    }, 500);

                } catch (error) {
                    console.error(error);
                    elements.loadingText.innerText = "FALHA NA INICIALIZA√á√ÉO";
                    elements.loadingText.classList.add('text-red-500');
                    elements.errorMsg.innerText = `Erro: ${error.message || "C√¢mera bloqueada ou sem conex√£o"}. Verifique as permiss√µes do navegador.`;
                    elements.errorMsg.classList.remove('hidden');
                    elements.btnRetry.classList.remove('hidden');
                }
            },

            start: (type) => {
                GameSystem.state.active = true;
                GameSystem.state.gameType = type;
                GameSystem.state.score = 0;
                
                // Reset Game Objects
                if(type === 'drive') GameLogic.Drive.reset();
                if(type === 'run') GameLogic.Run.reset();
                if(type === 'fight') GameLogic.Fight.reset();

                document.getElementById('screen-menu').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('flex');
                document.getElementById('screen-hud').classList.remove('hidden');
                document.getElementById('screen-hud').classList.add('flex');
                document.getElementById('screen-gameover').classList.add('hidden');

                GameSystem.loop();
            },

            stop: () => {
                GameSystem.state.active = false;
                cancelAnimationFrame(GameSystem.state.loopId);
                GameSystem.showMenu();
            },

            showMenu: () => {
                document.getElementById('screen-hud').classList.add('hidden');
                document.getElementById('screen-gameover').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
                document.getElementById('screen-menu').classList.add('flex');
                GameSystem.elements.ctx.clearRect(0,0, GameSystem.elements.canvas.width, GameSystem.elements.canvas.height);
            },

            setSens: (val) => {
                GameSystem.state.sensitivity = parseFloat(val);
                GameSystem.msg(`SENSIBILIDADE: ${val}x`, 'text-white');
            },

            msg: (txt, color) => {
                const el = document.getElementById('hud-message');
                el.innerHTML = `<h1 class="text-4xl font-black drop-shadow-md ${color} animate-pulse">${txt}</h1>`;
                clearTimeout(GameSystem.msgTimer);
                GameSystem.msgTimer = setTimeout(() => el.innerHTML = '', 1500);
            },

            loop: async () => {
                if(!GameSystem.state.active) return;

                // 1. Ajustar Canvas
                const cvs = GameSystem.elements.canvas;
                if(cvs.width !== window.innerWidth) {
                    cvs.width = window.innerWidth;
                    cvs.height = window.innerHeight;
                }

                // 2. Detectar Pose
                let pose = null;
                try {
                    const poses = await GameSystem.models.detector.estimatePoses(GameSystem.elements.videoInput);
                    if(poses.length > 0) pose = poses[0];
                } catch(e) {}

                // 3. Atualizar Jogo Atual
                const ctx = GameSystem.elements.ctx;
                const w = cvs.width;
                const h = cvs.height;
                let score = 0;

                if(GameSystem.state.gameType === 'drive') score = GameLogic.Drive.update(ctx, w, h, pose);
                if(GameSystem.state.gameType === 'run') score = GameLogic.Run.update(ctx, w, h, pose);
                if(GameSystem.state.gameType === 'fight') score = GameLogic.Fight.update(ctx, w, h, pose);

                document.getElementById('hud-score').innerText = score.toString().padStart(4, '0');

                GameSystem.state.loopId = requestAnimationFrame(GameSystem.loop);
            },

            gameOver: (finalScore) => {
                GameSystem.state.active = false;
                cancelAnimationFrame(GameSystem.state.loopId);
                document.getElementById('final-score').innerText = finalScore;
                document.getElementById('screen-hud').classList.add('hidden');
                document.getElementById('screen-gameover').classList.remove('hidden');
                document.getElementById('screen-gameover').classList.add('flex');
            }
        };

        /**
         * ==========================================
         * L√ìGICA DOS JOGOS (Separada e Limpa)
         * ==========================================
         */
        const GameLogic = {
            
            // JOGO 1: CORRIDA (Volante)
            Drive: {
                x: 0, speed: 0, roadPos: 0,
                reset: () => { GameLogic.Drive.x = 0; GameLogic.Drive.speed = 0; GameSystem.msg("M√ÉOS AO VOLANTE!", "text-yellow-400"); },
                update: (ctx, w, h, pose) => {
                    const d = GameLogic.Drive;
                    
                    // Input
                    let turn = 0;
                    if(pose) {
                        const lw = pose.keypoints.find(k=>k.name==='left_wrist');
                        const rw = pose.keypoints.find(k=>k.name==='right_wrist');
                        if(lw && rw && lw.score > 0.3 && rw.score > 0.3) {
                            // C√°lculo Angular para Volante
                            const dy = rw.y - lw.y;
                            turn = dy * 0.05 * GameSystem.state.sensitivity;
                            if(d.speed < 100) d.speed += 2;
                        } else {
                            if(d.speed > 0) d.speed -= 1;
                        }
                    }

                    // F√≠sica
                    d.x += turn * (d.speed/500);
                    d.x = Math.max(-1, Math.min(1, d.x));
                    d.roadPos += d.speed;

                    // Draw
                    ctx.clearRect(0,0,w,h);
                    
                    // C√©u
                    ctx.fillStyle = '#001'; ctx.fillRect(0,0,w,h/2);
                    // Ch√£o
                    ctx.fillStyle = '#111'; ctx.fillRect(0,h/2,w,h/2);
                    
                    // Estrada
                    const cx = w/2;
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.moveTo(cx - 10, h/2); ctx.lineTo(cx + 10, h/2);
                    ctx.lineTo(cx + w, h); ctx.lineTo(cx - w, h);
                    ctx.fill();

                    // Carro
                    const carX = cx + (d.x * w/3);
                    ctx.fillStyle = 'red';
                    ctx.shadowBlur = 20; ctx.shadowColor = 'red';
                    ctx.fillRect(carX - 40, h - 80, 80, 40);
                    ctx.shadowBlur = 0;

                    // Colis√£o Simples
                    if(Math.abs(d.x) > 0.9 && d.speed > 50) GameSystem.msg("CUIDADO!", "text-red-500");

                    return Math.floor(d.roadPos/100);
                }
            },

            // JOGO 2: RUNNER (Pular/Desviar)
            Run: {
                lane: 0, score: 0, obs: [],
                reset: () => { GameLogic.Run.obs = []; GameLogic.Run.score = 0; GameSystem.msg("CORRA!", "text-green-400"); },
                update: (ctx, w, h, pose) => {
                    const r = GameLogic.Run;
                    
                    // Input
                    if(pose) {
                        const nose = pose.keypoints.find(k=>k.name==='nose');
                        if(nose) {
                            if(nose.x < 210) r.lane = -1;
                            else if(nose.x > 430) r.lane = 1;
                            else r.lane = 0;
                        }
                    }

                    // Spawn Obst√°culos
                    if(Math.random() < 0.05) r.obs.push({l: Math.floor(Math.random()*3)-1, y: 0});

                    // Draw Background
                    ctx.fillStyle = '#002'; ctx.fillRect(0,0,w,h);
                    
                    // Lanes
                    const cx = w/2;
                    ctx.strokeStyle = '#0ff';
                    ctx.beginPath(); ctx.moveTo(cx-100, 0); ctx.lineTo(cx-100, h); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(cx+100, 0); ctx.lineTo(cx+100, h); ctx.stroke();

                    // Obstacles logic
                    r.obs.forEach((o, i) => {
                        o.y += 10 + (r.score/500);
                        const ox = cx + (o.l * 200);
                        
                        // Draw Block
                        ctx.fillStyle = 'orange';
                        ctx.fillRect(ox-40, o.y, 80, 50);

                        // Colis√£o (Player est√° em Y = h-100 aprox)
                        if(o.y > h-150 && o.y < h && o.l === r.lane) {
                            GameSystem.gameOver(r.score);
                        }
                        if(o.y > h) { r.obs.splice(i, 1); r.score+=10; }
                    });

                    // Player
                    const px = cx + (r.lane * 200);
                    ctx.fillStyle = '#0f0';
                    ctx.beginPath(); ctx.arc(px, h-100, 30, 0, Math.PI*2); ctx.fill();

                    return r.score;
                }
            },

            // JOGO 3: LUTA (Alvos)
            Fight: {
                targets: [], score: 0,
                reset: () => { GameLogic.Fight.targets = []; GameLogic.Fight.score = 0; GameSystem.msg("SOQUE!", "text-purple-400"); },
                update: (ctx, w, h, pose) => {
                    const f = GameLogic.Fight;

                    // Spawn
                    if(Math.random() < 0.03) {
                        f.targets.push({
                            x: Math.random()*(w-100)+50, 
                            y: Math.random()*(h/2)+50, 
                            r: 50, life: 100 
                        });
                    }

                    ctx.clearRect(0,0,w,h);

                    // Input Check
                    const hands = [];
                    if(pose) {
                        const lw = pose.keypoints.find(k=>k.name==='left_wrist');
                        const rw = pose.keypoints.find(k=>k.name==='right_wrist');
                        
                        // Mapear Coordenadas de V√≠deo (640x480) para Tela
                        const mapX = (val) => (1 - val/640) * w; // Invertido
                        const mapY = (val) => (val/480) * h;

                        if(lw && lw.score > 0.3) hands.push({x: mapX(lw.x), y: mapY(lw.y)});
                        if(rw && rw.score > 0.3) hands.push({x: mapX(rw.x), y: mapY(rw.y)});
                        
                        // Desenhar M√£os
                        ctx.fillStyle = 'cyan';
                        hands.forEach(hn => {
                            ctx.beginPath(); ctx.arc(hn.x, hn.y, 20, 0, Math.PI*2); ctx.fill();
                        });
                    }

                    // Targets Logic
                    f.targets.forEach((t, i) => {
                        t.life -= 1;
                        t.r = 30 + Math.sin(Date.now()/100)*5;

                        // Draw
                        ctx.beginPath();
                        ctx.arc(t.x, t.y, t.r, 0, Math.PI*2);
                        ctx.fillStyle = `rgba(255, 0, 255, ${t.life/100})`;
                        ctx.fill();
                        ctx.strokeStyle = '#fff'; ctx.stroke();

                        // Hit Check
                        let hit = false;
                        hands.forEach(hPos => {
                            const dist = Math.hypot(hPos.x - t.x, hPos.y - t.y);
                            // Sensibilidade aplicada ao raio de colis√£o
                            if(dist < t.r * GameSystem.state.sensitivity) hit = true;
                        });

                        if(hit) {
                            f.targets.splice(i, 1);
                            f.score += 100;
                            GameSystem.msg("HIT!", "text-yellow-400");
                        } else if(t.life <= 0) {
                            f.targets.splice(i, 1);
                        }
                    });

                    return f.score;
                }
            }
        };

        // Prevenir Zoom no iOS ao dar duplo toque
        document.addEventListener('dblclick', function(event) {
            event.preventDefault();
        }, { passive: false });

    </script>
</body>
</html>
