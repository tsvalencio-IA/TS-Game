<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>thIAguinho AR | Jogo Completo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    
    <style>
        /* --- ESTILOS DE ALTA PERFORMANCE (GAME UI) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; position: fixed; width: 100%; height: 100%; }

        /* LAYER 1: CÂMERA (AR BACKGROUND) */
        #cam-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; transform: scaleX(-1); filter: brightness(0.7);
        }

        /* LAYER 2: 3D WORLD */
        #game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* LAYER 3: HUD (Interface de Jogo) */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        .hud-header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        }

        .score-container { text-align: right; color: #ffcc00; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .label { font-size: 10px; font-weight: bold; letter-spacing: 1px; color: #fff; text-transform: uppercase; }
        .big-number { font-size: 32px; font-weight: 900; font-family: monospace; line-height: 1; }

        .btn-icon {
            background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
            width: 40px; height: 40px; border-radius: 50%; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; cursor: pointer; backdrop-filter: blur(4px);
        }

        /* TELAS DE ESTADO (Start / Game Over) */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center; backdrop-filter: blur(8px);
            transition: opacity 0.3s;
        }

        .hidden { display: none !important; opacity: 0; }

        h1 { font-size: 36px; color: #ffcc00; font-style: italic; margin-bottom: 10px; text-transform: uppercase; }
        h2 { font-size: 24px; color: #fff; margin-bottom: 20px; }
        
        .action-btn {
            background: linear-gradient(45deg, #ffcc00, #ffaa00); color: #000;
            padding: 15px 50px; border-radius: 50px; font-size: 18px; font-weight: 900;
            border: none; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.6);
            animation: pulse 1.5s infinite; pointer-events: auto;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* EFEITO DE DANO */
        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; z-index: 5; pointer-events: none;
            transition: opacity 0.1s;
        }

        /* ZONA DE TOQUE */
        .tap-zone {
            position: absolute; bottom: 0; width: 100%; height: 40%;
            background: linear-gradient(to top, rgba(255,204,0,0.1), transparent);
            display: flex; justify-content: center; align-items: flex-end; padding-bottom: 30px;
            font-size: 12px; color: rgba(255,255,255,0.6); pointer-events: auto;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/DRACOLoader.js"></script>
</head>
<body>

    <video id="cam-feed" autoplay playsinline muted></video>
    
    <div id="damage-overlay"></div>

    <div id="ui-layer">
        <div class="hud-header">
            <button onclick="window.location.href='index.html'" class="btn-icon"><i class='bx bx-arrow-back'></i></button>
            <div class="score-container">
                <div class="label">PONTOS</div>
                <div class="big-number" id="score-val">0</div>
                <div class="label" style="margin-top:5px; color:#aaa;">RECORD: <span id="high-score-val">0</span></div>
            </div>
        </div>
        <div class="tap-zone" id="control-zone">
            <p><i class='bx bxs-hand-up'></i> TOQUE PARA ACELERAR | INCLINE PARA DESVIAR</p>
        </div>
    </div>

    <div id="start-screen" class="overlay-screen">
        <div style="width: 80px; height: 80px; background: #ffcc00; border-radius: 50%; margin-bottom: 20px; display:flex; align-items:center; justify-content:center;">
            <i class='bx bxs-car-crash' style="font-size: 40px; color: black;"></i>
        </div>
        <h1>Corrida AR</h1>
        <p style="max-width: 80%; margin-bottom: 30px; font-size: 14px; color: #ccc;">
            Desvie dos obstáculos vermelhos!<br>
            Incline o celular para os lados.
        </p>
        <button class="action-btn" onclick="Game.init()">INICIAR MOTORES</button>
    </div>

    <div id="game-over-screen" class="overlay-screen hidden">
        <h1 style="color: #ff3333;">BATIDA!</h1>
        <p style="margin-bottom: 10px;">Pontuação Final</p>
        <div class="big-number" id="final-score" style="margin-bottom: 30px; color: #fff;">0</div>
        <button class="action-btn" onclick="Game.restart()">TENTAR DE NOVO</button>
    </div>

    <script>
        /**
         * thIAguinho AR - Game Logic Completa
         * Engine V2: Colisões, Objetivos, Game Loop Real.
         */

        const Game = {
            // Estado
            active: false,
            score: 0,
            highScore: localStorage.getItem('th_highscore') || 0,
            speed: 0,
            baseSpeed: 0.5,
            lane: 0, // -1 (Esq), 0 (Meio), 1 (Dir)
            
            // Objetos 3D
            scene: null, camera: null, renderer: null,
            mascot: null, floor: null,
            obstacles: [], // Array de inimigos
            
            // Constantes de Gameplay
            LANE_WIDTH: 2.5, // Distância entre pistas
            MAX_SPEED: 1.2,
            ACCEL: 0.05,
            SPAWN_RATE: 60, // Frames para criar obstáculo
            frame: 0,

            // Inicialização
            init: async function() {
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('high-score-val').innerText = this.highScore;
                
                await this.setupCamera();
                this.setup3D();
                this.setupInputs();
                
                this.active = true;
                this.animate();
            },

            setupCamera: async function() {
                const video = document.getElementById('cam-feed');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, audio: false 
                    });
                    video.srcObject = stream;
                } catch (e) { console.warn("Modo Debug (Sem câmera)"); }
            },

            setup3D: function() {
                // Cena
                this.scene = new THREE.Scene();
                
                // Luzes
                const amb = new THREE.AmbientLight(0xffffff, 0.6);
                const dir = new THREE.DirectionalLight(0xffffff, 1);
                dir.position.set(5, 10, 7);
                this.scene.add(amb, dir);

                // Câmera
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
                this.camera.position.set(0, 3, 6);
                this.camera.lookAt(0, 0, -5);

                // Renderizador
                this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.domElement.id = 'game-canvas';
                document.body.appendChild(this.renderer.domElement);

                // Chão Infinito
                const texLoader = new THREE.TextureLoader();
                const gridTex = texLoader.load('./assets/estrada.jpg');
                gridTex.wrapS = THREE.RepeatWrapping;
                gridTex.wrapT = THREE.RepeatWrapping;
                gridTex.repeat.set(1, 20);
                
                const floorGeo = new THREE.PlaneGeometry(8, 200);
                const floorMat = new THREE.MeshLambertMaterial({ map: gridTex, transparent: true, opacity: 0.9 });
                this.floor = new THREE.Mesh(floorGeo, floorMat);
                this.floor.rotation.x = -Math.PI / 2;
                this.floor.position.z = -80;
                this.scene.add(this.floor);

                // Carregar Mascote
                this.loadMascot();
            },

            loadMascot: function() {
                const loader = new THREE.GLTFLoader();
                const draco = new THREE.DRACOLoader();
                draco.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.5/');
                loader.setDRACOLoader(draco);

                loader.load('./assets/mascote.glb', (gltf) => {
                    this.mascot = gltf.scene;
                    
                    // Ajuste de escala e rotação
                    const box = new THREE.Box3().setFromObject(this.mascot);
                    const size = box.getSize(new THREE.Vector3());
                    const scale = 1.5 / size.y;
                    this.mascot.scale.setScalar(scale);
                    
                    this.mascot.position.set(0, 0, -2);
                    // Rotacionar para ficar de costas para a câmera
                    this.mascot.rotation.y = Math.PI; 
                    
                    this.scene.add(this.mascot);
                }, undefined, () => {
                    // Fallback se não achar modelo
                    const geo = new THREE.BoxGeometry(1, 2, 1);
                    const mat = new THREE.MeshNormalMaterial();
                    this.mascot = new THREE.Mesh(geo, mat);
                    this.mascot.position.set(0, 1, -2);
                    this.scene.add(this.mascot);
                });
            },

            setupInputs: function() {
                // Tilt (Giroscópio)
                window.addEventListener('deviceorientation', (e) => {
                    if(!this.active) return;
                    const tilt = e.gamma || 0; 
                    // Zona morta de 5 graus para evitar tremedeira
                    if(tilt > 10) this.lane = 1;
                    else if(tilt < -10) this.lane = -1;
                    else this.lane = 0;
                });

                // Touch (Boost de velocidade)
                const zone = document.getElementById('control-zone');
                zone.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Evita zoom
                    if(this.active) this.speed = Math.min(this.speed + 0.2, this.MAX_SPEED);
                });

                // Teclado (Debug PC)
                window.addEventListener('keydown', (e) => {
                    if(e.key === 'ArrowLeft') this.lane = -1;
                    if(e.key === 'ArrowRight') this.lane = 1;
                    if(e.key === 'ArrowUp') this.lane = 0;
                });

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            },

            // --- LÓGICA DE JOGO (CORE LOOP) ---
            
            spawnObstacle: function() {
                // Cria caixas/cones vermelhos
                const geo = new THREE.ConeGeometry(0.5, 1.5, 16);
                const mat = new THREE.MeshPhongMaterial({ color: 0xff0000, shininess: 100 });
                const obs = new THREE.Mesh(geo, mat);
                
                // Escolhe pista aleatória (-1, 0, 1)
                const randomLane = Math.floor(Math.random() * 3) - 1; 
                
                obs.position.set(randomLane * this.LANE_WIDTH, 0.75, -80); // Nasce longe
                obs.castShadow = true;
                
                this.scene.add(obs);
                this.obstacles.push(obs);
            },

            checkCollisions: function() {
                if(!this.mascot) return;

                // Caixa de colisão do jogador (simplificada)
                const playerX = this.mascot.position.x;
                const playerZ = this.mascot.position.z; // Deve ser approx -2

                for(let i = 0; i < this.obstacles.length; i++) {
                    const obs = this.obstacles[i];
                    
                    // Distância Z (Profundidade)
                    const distZ = Math.abs(obs.position.z - playerZ);
                    // Distância X (Lateral)
                    const distX = Math.abs(obs.position.x - playerX);

                    // Se estiver muito perto em Z (< 1.0) e na mesma pista em X (< 0.8)
                    if(distZ < 1.5 && distX < 1.0) {
                        this.gameOver();
                    }
                }
            },

            update: function() {
                if(!this.active) return;

                // 1. Velocidade Base + Inércia
                this.speed = Math.max(this.speed * 0.98, this.baseSpeed); // Atrito natural
                
                // 2. Pontuação
                this.score += Math.round(this.speed * 2);
                document.getElementById('score-val').innerText = this.score;

                // Aumenta dificuldade a cada 1000 pontos
                if(this.score % 1000 === 0) {
                    this.baseSpeed += 0.05;
                    this.SPAWN_RATE = Math.max(20, this.SPAWN_RATE - 2);
                }

                // 3. Movimento Mascote
                if(this.mascot) {
                    const targetX = this.lane * this.LANE_WIDTH;
                    // Lerp suave para mudar de pista
                    this.mascot.position.x += (targetX - this.mascot.position.x) * 0.15;
                    
                    // Inclinação do corpo ao virar
                    this.mascot.rotation.z = -(this.mascot.position.x - targetX) * 0.3;
                    this.mascot.rotation.y = Math.PI; // Mantém de costas
                }

                // 4. Movimento Pista (Visual)
                if(this.floor.material.map) {
                    this.floor.material.map.offset.y -= this.speed * 0.02;
                }

                // 5. Gerenciar Obstáculos
                this.frame++;
                if(this.frame % this.SPAWN_RATE === 0) {
                    this.spawnObstacle();
                }

                // Mover e limpar obstáculos
                for(let i = this.obstacles.length - 1; i >= 0; i--) {
                    let obs = this.obstacles[i];
                    obs.position.z += this.speed; // Move em direção à câmera

                    // Remove se passou da câmera
                    if(obs.position.z > 5) {
                        this.scene.remove(obs);
                        this.obstacles.splice(i, 1);
                    }
                }

                // 6. Verificar Batida
                this.checkCollisions();
            },

            animate: function() {
                if(!this.active) return;
                requestAnimationFrame(() => this.animate());
                this.update();
                this.renderer.render(this.scene, this.camera);
            },

            gameOver: function() {
                this.active = false;
                
                // Feedback Visual
                const flash = document.getElementById('damage-overlay');
                flash.style.opacity = 0.8;
                setTimeout(() => flash.style.opacity = 0, 200);

                // Salvar Recorde
                if(this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('th_highscore', this.highScore);
                }

                // Mostrar Tela
                document.getElementById('final-score').innerText = this.score;
                document.getElementById('game-over-screen').classList.remove('hidden');
            },

            restart: function() {
                // Resetar Variáveis
                this.score = 0;
                this.baseSpeed = 0.5;
                this.speed = 0;
                this.obstacles.forEach(obs => this.scene.remove(obs));
                this.obstacles = [];
                
                // UI
                document.getElementById('game-over-screen').classList.add('hidden');
                document.getElementById('high-score-val').innerText = this.highScore;
                
                // Reiniciar Loop
                this.active = true;
                this.animate();
            }
        };

        // Previne scroll no iOS
        document.body.addEventListener('touchmove', function(e){ e.preventDefault(); }, { passive: false });

    </script>
</body>
</html>
