<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>thIAguinho Arcade | Engine Ultimate</title>
    
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    
    <style>
        /* --- CORE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; position: fixed; width: 100%; height: 100%; }

        /* LAYER 1: CÂMERA (AR BACKGROUND) */
        #cam-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; transform: scaleX(-1); filter: brightness(0.6);
        }

        /* LAYER 2: 3D CANVAS */
        #game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* LAYER 3: UI / HUD */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* HUD: TOPO */
        .hud-top {
            padding: 15px; display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: auto;
        }
        .score-box { text-align: right; color: #ffcc00; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .score-val { font-size: 32px; font-weight: 900; font-family: monospace; line-height: 1; }
        .record-label { font-size: 10px; color: #aaa; text-transform: uppercase; }

        .btn-circle {
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center;
            font-size: 22px; cursor: pointer; backdrop-filter: blur(4px); margin-bottom: 10px;
        }
        .btn-circle:active { transform: scale(0.9); background: rgba(255,204,0,0.8); color: black; }

        /* CONTROLES DE JOGO (Touch Overlay) */
        .controls-overlay {
            position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px;
            pointer-events: auto;
        }
        .pedal {
            width: 80px; height: 80px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center; font-size: 30px; color: white;
            transition: all 0.1s; backdrop-filter: blur(5px);
        }
        .brake { background: rgba(255, 0, 0, 0.3); }
        .gas { background: rgba(0, 255, 0, 0.3); }
        .pedal:active { transform: scale(0.95); opacity: 0.8; }
        
        /* MODO RUN (TAP ZONE) */
        #tap-zone {
            position: absolute; bottom: 0; width: 100%; height: 40%;
            background: linear-gradient(to top, rgba(0,255,255,0.2), transparent);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; font-weight: bold; text-transform: uppercase;
            opacity: 0; pointer-events: auto; transition: opacity 0.3s;
        }

        /* MENU DE CONFIGURAÇÕES */
        #settings-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; background: rgba(20, 20, 20, 0.95); border: 2px solid #ffcc00;
            border-radius: 15px; padding: 20px; z-index: 100; color: white;
            display: none; flex-direction: column; gap: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; }
        .toggle-btn {
            background: #333; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid #555;
        }
        .toggle-btn.active { background: #ffcc00; color: black; border-color: #ffcc00; font-weight: bold; }
        
        input[type=range] { width: 100%; accent-color: #ffcc00; margin-top: 5px; }

        /* TELAS (Start / GameOver) */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; }
        
        .big-btn {
            background: linear-gradient(90deg, #ffcc00, #ff9900); color: black;
            padding: 15px 40px; border-radius: 50px; border: none; font-weight: 900; font-size: 18px;
            margin-top: 20px; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.4);
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/DRACOLoader.js"></script>
</head>
<body>

    <video id="cam-feed" autoplay playsinline muted></video>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="left-tools">
                <div class="btn-circle" onclick="window.location.href='index.html'"><i class='bx bx-home'></i></div>
                <div class="btn-circle" onclick="UI.toggleSettings()"><i class='bx bxs-cog'></i></div>
            </div>
            <div class="score-box">
                <div class="record-label" id="mode-title">MODO</div>
                <div class="score-val" id="score-display">0</div>
                <div class="record-label">RECORD: <span id="record-display">0</span></div>
            </div>
        </div>

        <div id="race-controls" class="controls-overlay">
            <div class="pedal brake" id="btn-brake"><i class='bx bxs-chevrons-down'></i></div>
            <div class="pedal gas" id="btn-gas"><i class='bx bxs-chevrons-up'></i></div>
        </div>

        <div id="tap-zone">
            TOQUE RÁPIDO PARA CORRER!<br><span style="font-size: 14px; font-weight:normal">(Mantenha o ritmo)</span>
        </div>
    </div>

    <div id="settings-panel">
        <h3 style="color:#ffcc00; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">CONFIGURAÇÕES</h3>
        
        <div class="setting-row">
            <span>Controle:</span>
            <div style="display:flex; gap:5px;">
                <div id="opt-tilt" class="toggle-btn active" onclick="Settings.setControl('tilt')">INCLINAR</div>
                <div id="opt-touch" class="toggle-btn" onclick="Settings.setControl('touch')">TOCAR</div>
            </div>
        </div>

        <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <div style="display:flex; justify-content:space-between; width:100%">
                <span>Sensibilidade Lateral:</span>
                <span id="sens-val" style="color:#ffcc00">1.0</span>
            </div>
            <input type="range" min="0.1" max="3.0" step="0.1" value="1.0" oninput="Settings.setSensitivity(this.value)">
        </div>

        <button class="big-btn" style="width:100%; padding:10px; margin-top:10px; font-size:14px;" onclick="UI.toggleSettings()">FECHAR</button>
    </div>

    <div id="start-screen" class="screen">
        <div style="font-size: 60px; color: #ffcc00; margin-bottom: 20px;">
            <i class='bx bxs-game'></i>
        </div>
        <h1 id="start-title">CARREGANDO...</h1>
        <p id="start-desc" style="max-width: 80%; color: #ccc; margin-bottom: 30px;">
            Preparando a engine...
        </p>
        <button class="big-btn" onclick="Game.start()">JOGAR AGORA</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #ff3333;">FIM DE JOGO</h1>
        <p>Pontuação Final</p>
        <div class="score-val" id="final-score" style="margin: 20px 0; color: white;">0</div>
        <button class="big-btn" onclick="Game.restart()">TENTAR DE NOVO</button>
    </div>

    <script>
        /**
         * thIAguinho Arcade Engine V3.0 - Ultimate
         * Suporte a múltiplos modos, ajustes finos e persistência.
         */

        // --- GERENCIADOR DE CONFIGURAÇÕES ---
        const Settings = {
            controlMode: 'tilt', // 'tilt' (giroscópio) ou 'touch' (seguir dedo)
            sensitivity: 1.0,

            setControl: function(mode) {
                this.controlMode = mode;
                document.getElementById('opt-tilt').className = mode === 'tilt' ? 'toggle-btn active' : 'toggle-btn';
                document.getElementById('opt-touch').className = mode === 'touch' ? 'toggle-btn active' : 'toggle-btn';
            },

            setSensitivity: function(val) {
                this.sensitivity = parseFloat(val);
                document.getElementById('sens-val').innerText = this.sensitivity.toFixed(1);
            }
        };

        // --- UI MANAGER ---
        const UI = {
            toggleSettings: function() {
                const el = document.getElementById('settings-panel');
                el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            },
            updateScore: function(val, record) {
                document.getElementById('score-display').innerText = Math.floor(val);
                document.getElementById('record-display').innerText = Math.floor(record);
            },
            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                const el = document.getElementById(id);
                if(el) el.classList.remove('hidden');
            }
        };

        // --- CORE GAME ENGINE ---
        const Game = {
            mode: 'race', // 'race' ou 'run'
            active: false,
            score: 0,
            highScore: 0,
            
            // Física
            speed: 0,
            maxSpeed: 1.0,
            laneX: 0,
            
            // ThreeJS
            scene: null, camera: null, renderer: null,
            mascot: null, floor: null,
            obstacles: [],
            
            // Controles Internos
            touchX: 0,
            frame: 0,

            init: async function() {
                // 1. Detectar Modo via URL
                const params = new URLSearchParams(window.location.search);
                this.mode = params.get('mode') || 'race';
                
                // 2. Carregar Recorde Específico
                this.highScore = localStorage.getItem(`th_record_${this.mode}`) || 0;
                UI.updateScore(0, this.highScore);

                // 3. Configurar UI Baseada no Modo
                this.setupModeUI();

                // 4. Iniciar Hardware (Câmera)
                await this.initCamera();

                // 5. Iniciar 3D
                this.init3D();

                // 6. Bind Inputs
                this.bindInputs();

                // Pronto
                document.getElementById('start-title').innerText = this.mode === 'race' ? 'TURBO RACE' : 'MARATONA RUN';
                document.getElementById('start-desc').innerText = this.mode === 'race' 
                    ? 'Desvie dos obstáculos e use o Turbo!' 
                    : 'Toque rápido na tela para correr!';
            },

            setupModeUI: function() {
                const title = document.getElementById('mode-title');
                const raceCtrls = document.getElementById('race-controls');
                const runZone = document.getElementById('tap-zone');

                if (this.mode === 'race') {
                    title.innerText = "GRAND PRIX";
                    raceCtrls.style.display = 'flex';
                    runZone.style.display = 'none';
                } else if (this.mode === 'run') {
                    title.innerText = "CORRIDA DE RUA";
                    raceCtrls.style.display = 'none';
                    runZone.style.display = 'flex';
                    runZone.style.opacity = 1;
                    Settings.setControl('touch'); // Run usa toque por padrão
                }
            },

            initCamera: async function() {
                const video = document.getElementById('cam-feed');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, audio: false 
                    });
                    video.srcObject = stream;
                } catch(e) { console.log("Câmera não disponível (Debug PC)"); }
            },

            init3D: function() {
                this.scene = new THREE.Scene();
                
                // Iluminação
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
                const dir = new THREE.DirectionalLight(0xffffff, 1);
                dir.position.set(5, 10, 7);
                dir.castShadow = true;
                this.scene.add(hemi, dir);

                // Câmera
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
                this.camera.position.set(0, 2.5, 5);
                this.camera.lookAt(0, 0, -4);

                // Renderer
                this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.domElement.id = 'game-canvas';
                document.body.appendChild(this.renderer.domElement);

                // Objetos
                this.createFloor();
                this.loadMascot();
                
                // Loop
                this.animate();
            },

            createFloor: function() {
                const tex = new THREE.TextureLoader().load('./assets/estrada.jpg');
                tex.wrapS = THREE.RepeatWrapping;
                tex.wrapT = THREE.RepeatWrapping;
                tex.repeat.set(1, 20);
                
                const mat = new THREE.MeshLambertMaterial({ map: tex, transparent: true, opacity: 0.85 });
                this.floor = new THREE.Mesh(new THREE.PlaneGeometry(8, 200), mat);
                this.floor.rotation.x = -Math.PI / 2;
                this.floor.position.z = -80;
                this.scene.add(this.floor);
            },

            loadMascot: function() {
                const loader = new THREE.GLTFLoader();
                const draco = new THREE.DRACOLoader();
                draco.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.5/');
                loader.setDRACOLoader(draco);

                loader.load('./assets/mascote.glb', (gltf) => {
                    this.mascot = gltf.scene;
                    const box = new THREE.Box3().setFromObject(this.mascot);
                    const scale = 1.5 / box.getSize(new THREE.Vector3()).y;
                    this.mascot.scale.setScalar(scale);
                    this.mascot.position.set(0, 0, -2);
                    this.mascot.rotation.y = Math.PI;
                    this.scene.add(this.mascot);
                }, undefined, () => {
                    // Fallback
                    const cube = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshNormalMaterial());
                    cube.position.set(0,1,-2);
                    this.mascot = cube;
                    this.scene.add(this.mascot);
                });
            },

            bindInputs: function() {
                // TILT
                window.addEventListener('deviceorientation', (e) => {
                    if(!this.active || Settings.controlMode !== 'tilt') return;
                    // Gamma = Left/Right (-90 to 90)
                    // Aplica sensibilidade
                    let tilt = e.gamma || 0;
                    this.laneX = (tilt * 0.05) * Settings.sensitivity; 
                    // Limita a pista
                    this.laneX = Math.max(-3.5, Math.min(3.5, this.laneX));
                });

                // TOUCH (Slide para mover ou Tap para correr)
                document.body.addEventListener('touchmove', (e) => {
                    if(!this.active || Settings.controlMode !== 'touch') return;
                    const x = (e.touches[0].clientX / window.innerWidth) * 2 - 1; // -1 a 1
                    this.laneX = x * 4 * Settings.sensitivity; // 4 é a largura da pista
                });

                // BOTÕES DE JOGO (Race)
                const btnGas = document.getElementById('btn-gas');
                const btnBrake = document.getElementById('btn-brake');
                
                // Acelerar
                const accelerate = () => { if(this.active) this.speed = Math.min(this.speed + 0.05, 1.5); };
                const brake = () => { if(this.active) this.speed = Math.max(this.speed - 0.1, 0); };

                btnGas.addEventListener('touchstart', (e) => { e.preventDefault(); this.isAccelerating = true; });
                btnGas.addEventListener('touchend', () => { this.isAccelerating = false; });
                
                btnBrake.addEventListener('touchstart', (e) => { e.preventDefault(); this.isBraking = true; });
                btnBrake.addEventListener('touchend', () => { this.isBraking = false; });

                // ZONA DE TAP (Run)
                const tapZone = document.getElementById('tap-zone');
                tapZone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if(this.active && this.mode === 'run') {
                        this.speed = Math.min(this.speed + 0.2, 1.2);
                        // Efeito visual de pulo
                        if(this.mascot) this.mascot.position.y = 0.5;
                    }
                });
            },

            start: function() {
                UI.showScreen(null); // Esconde start screen
                this.active = true;
                this.score = 0;
                this.speed = 0;
                this.obstacles = [];
            },

            // --- GAME LOOP ---
            update: function() {
                if(!this.active) return;

                // 1. Lógica de Velocidade por Modo
                if(this.mode === 'race') {
                    // Race: Mantém velocidade base, botões alteram
                    if(this.isAccelerating) this.speed += 0.02;
                    else if(this.isBraking) this.speed -= 0.05;
                    else this.speed *= 0.99; // Atrito leve

                    // Limites
                    this.speed = Math.max(0, Math.min(this.speed, 1.5));

                } else if (this.mode === 'run') {
                    // Run: Velocidade cai rápido, precisa de Taps constantes
                    this.speed *= 0.95; 
                    if(this.mascot && this.mascot.position.y > 0) this.mascot.position.y -= 0.05; // Gravidade pulo
                    if(this.mascot && this.mascot.position.y < 0) this.mascot.position.y = 0;
                }

                // 2. Movimento Mascote
                if(this.mascot) {
                    // Lerp para suavizar movimento lateral
                    this.mascot.position.x += (this.laneX - this.mascot.position.x) * 0.1;
                    
                    // Inclinação visual nas curvas
                    this.mascot.rotation.z = -(this.laneX - this.mascot.position.x) * 0.5;
                    this.mascot.rotation.y = Math.PI; 
                }

                // 3. Movimento Cenário
                if(this.floor && this.floor.material.map) {
                    this.floor.material.map.offset.y -= this.speed * 0.05;
                }

                // 4. Pontuação e Obstáculos (Apenas Race tem obstáculos por enquanto)
                if(this.speed > 0.1) {
                    this.score += this.speed;
                    UI.updateScore(this.score, this.highScore);
                }

                // Spawn Obstáculos (Race Only)
                this.frame++;
                if(this.mode === 'race' && this.frame % 60 === 0 && this.speed > 0.2) {
                    this.spawnObstacle();
                }

                this.manageObstacles();
            },

            spawnObstacle: function() {
                const geo = new THREE.ConeGeometry(0.5, 1.5, 16);
                const mat = new THREE.MeshPhongMaterial({ color: 0xff0000 });
                const obs = new THREE.Mesh(geo, mat);
                
                // Nasce em uma das 3 faixas virtuais ou aleatório
                const lanes = [-2.5, 0, 2.5];
                const lane = lanes[Math.floor(Math.random() * lanes.length)];
                
                obs.position.set(lane, 0.75, -80);
                this.scene.add(obs);
                this.obstacles.push(obs);
            },

            manageObstacles: function() {
                for(let i = this.obstacles.length - 1; i >= 0; i--) {
                    let obs = this.obstacles[i];
                    obs.position.z += this.speed * 2; // Obstáculos vêm na velocidade do chão

                    // Colisão Simples (Box)
                    if(this.mascot) {
                        const dx = Math.abs(obs.position.x - this.mascot.position.x);
                        const dz = Math.abs(obs.position.z - this.mascot.position.z);
                        if(dx < 1.0 && dz < 1.0) {
                            this.gameOver();
                        }
                    }

                    // Limpeza
                    if(obs.position.z > 5) {
                        this.scene.remove(obs);
                        this.obstacles.splice(i, 1);
                    }
                }
            },

            gameOver: function() {
                this.active = false;
                
                // Salvar Recorde
                if(this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem(`th_record_${this.mode}`, Math.floor(this.highScore));
                }

                document.getElementById('final-score').innerText = Math.floor(this.score);
                UI.showScreen('game-over-screen');
            },

            restart: function() {
                this.obstacles.forEach(o => this.scene.remove(o));
                this.obstacles = [];
                this.score = 0;
                this.speed = 0;
                this.mascot.position.x = 0;
                this.laneX = 0;
                UI.showScreen(null);
                this.active = true;
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                this.update();
                if(this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            }
        };

        // Bootstrap
        window.onload = () => Game.init();
        
        // Previne scroll
        document.body.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    </script>
</body>
</html>
